//Como acabamos de empezar con ficheros, los dejamos para la siguiente versión del código
//Los dejamos indicados


//Bibliotecas
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <windows.h>
#include "SerialPort.h" //Arduino
#include "SerialPort.c" //Arduino

//Constantes
#define MAX_DATA_LENGTH 255 //Arduino

//Estructuras
/*typedef struct {
	char nombre[30];
	int dni[8]; //ponemos el dni de contraseña
}CUENTAS;*/

void crearcuenta();
void iniciarsesion();
void ajustescuenta();
void consultasaldo();
void transferencia();
void ingresa_retira(SerialPort*, char*, char*);
void autoConnect(SerialPort*, char*);

int main()
{
	//CUENTAS cuenta;
	char sn;
	int opc;

	//Arduino
	SerialPort* arduino;
	char portName[] = "\\\\.\\COM3"; //Puerto serie
	char incomingData[MAX_DATA_LENGTH]; //Buffer
	arduino = (SerialPort*)malloc(sizeof(SerialPort));

	printf("¿Quiere crear una cuenta?\n 1- CREAR UNA CUENTA\n2- INICIAR SESION\n");
	scanf_s("%c", &sn);
	getchar();

	do
	{
		if (sn == '1')
			crearcuenta();
		else if (sn == '2')
			iniciarsesion();
	} while (sn != '1' && sn != '2');
	
	do
	{
		printf("Elija una operacion:\n\t1. Consultar saldo. \n\t2. Ingresar dinero o Retirar dinero. \n\t3. Transferencia. \n\t4. Ajustes. \n\t5. Consultar movimientos. \n\t6. Salir. \n");
		scanf_s("%d", &opc);

		switch (opc)
		{
		
		case 1:
			consultasaldo();
			break;

		case 2:
			ingresa_retira(arduino, portName, incomingData);
			break;

		case 3:
			transferencia();
			break;

		case 4:
			break;

		case 5:
			break;

		case 6:
			printf("Salir.");
			break;

		default:
			printf("Opcion incorrecta.");
		}

	} while (opc != 6);


}

void crearcuenta()
{
	char nom[30], dni[10], email[15];
	int i, letra = 0, num = 0, longmail = 0;
	float dinero;
	printf("Por favor, introduzca los datos requeridos:\nNombre y apellidos:");
	gets_s(nom);
	getchar();

	do
	{
		letra = 0;
		printf("\nDNI con letra minuscula:\n");
		gets_s(dni);
		for (i = 0; i < 10; i++)
		{
			if (dni[i] > 96 && dni[i] < 123)
				letra++;
			else
				num++;
		}
		if (letra != 1 || num != 8)
			printf("\nDNI incorrecto\n");
	} while (letra != 1 || num != 8);

	do 
	{
		letra = 0;
		printf("\nIntroduzca e-mail:");
		gets_s(email);
		longmail = strlen(email);
		for (i = 0; i < longmail; i++)
		{
			if (email[i] == '@')
				letra++;
		}
		if (letra != 1)
			printf("\nEmail incorrecto.\n");
	} while (letra != 1);
	
	do
	{
		printf("\Introduzca su saldo inicial:\n");
		scanf_s("%f", &dinero);
	} while (dinero <= 0);

	//Añadiremos las variables a un fichero desde el cual serán accesibles
}

void iniciarsesion()
{
	char usuario[15], dni[10];
	int opc;
	printf("Usuario:");
	gets_s(usuario);
	getchar();
	printf("\nDNI:");
	gets_s(dni);
	getchar();
	//comprobamos que existen con un fichero, y entramos en la cuenta correspondiente
}

void ajustescuenta()
{

}

void consultasaldo()
{
	//leerá e imprimirá el saldo de la cuenta correspondiente en el fichero
}

void ingresa_retira(SerialPort* arduino, char* portName, char* incomingData)
{
	//leerá y guardará en una variable el saldo de la cuenta correspondiente en el fichero
	int opc, dinero;
	char sendData; //Arduino
	printf("¿Quiere ingresar o retirar?\ 1-\tRetirar\n2-\tIngresar");
	scanf_s("%d", &opc);

	if (opc == 1)
	{
		do
		{
			printf("¿Cuanto dinero quiere retirar?");
			scanf_s("%d", &dinero);
			//hay que comprobar si se dispone de ese saldo: if(dinero<=saldo)
			//saldo-=dinero
			//si no:
			printf("Dinero insuficiente.");
		} while (//saldo<dinero);
			//se imprime el nuevo saldo en el fichero
	}

	if (opc == 2)
	{
		printf("¿Cuanto dinero quiere ingresar?");
		scanf_s("%d", &dinero);
		//saldo+=dinero
		//se imprime el nuevo saldo en el fichero
	}

	//Arduino
	Crear_Conexion(arduino, portName);
	autoConnect(arduino, incomingData);
}

void transferencia(char[])
{
	char nom[10];
	int dinero1, dinero2, euros; //Se sacarán del fichero cuando lo incluyamos
	//Se obtiene el saldo de la cuenta correspondiente en el fichero (dinero1)
	printf("¿A que cuenta lo quiere enviar?");
	gets_s(nom);
	//Se comparará el nombre introducido con las cuentas del fichero
	//Si esa cuenta existe:
	//Se declarará una variable cuyo valor será el saldo correspondiente a dicha cuenta (dinero2)
	//Si dicha cuenta no existe, se preguntará otra vez con un bucle while
	printf("¿Cuanto dinero quiere transferir?");
	scanf_s("%d", &euros);
	if (euros > dinero1)
		printf("Cantidad insuficiente");
	if (euros <= dinero1)
	{
		dinero1 -= euros;
		dinero2 += euros;
	}
	//Se imprimen los nuevos saldos en el fichero
}

//Arduino
void autoConnect(SerialPort* arduino, char* incomingData) {
	char sendData = 0, receiveData = '0';

	// Espera la conexion con Arduino
	while (!isConnected(arduino))
	{
		Sleep(100);
		Crear_Conexion(arduino, arduino->portName);
	}

	//Comprueba si arduino esta conectado
	if (isConnected(arduino))
	{
		printf("Conectado con Arduino en el puerto %s\n", arduino->portName);
	}

	//Aplicacion
	sendData = '1';
	writeSerialPort(arduino, &sendData, sizeof(char));
	while (receiveData != '9')
	{
		receiveData = readSerialPort(arduino, incomingData, MAX_DATA_LENGTH);
	}

	if (!isConnected(arduino))
		printf("Se ha perdido la conexión con Arduino\n");
}
